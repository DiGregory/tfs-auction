# Аукцион

## Глоссарий
Лот - товар, который пользователь собирается выставить, продать.

## Функционал
1. Регистрация пользователя
2. Авторизация и аутентификация пользователя
3. Обновление профиля
4. Создание лота
5. Обновление информации о лоте
6. "Начать аукцион"
7. "Отменить аукцион"
8. Удалить лот
9. Получить список созданных пользователем лотов
10. Получить список лотов, которые выкупил пользователь
11. Получить список лотов, которые сейчас торгуются

### 1 Регистрация пользователя
Выполняет POST запрос на /api/v1/signup с сущностью пользователя в формате json.

### 2 Авторизация и аутентификация пользователя
Выполняется POST запрос на /api/v1/signin c полями (`email`, `password`) в формате json.
При успешной авторизации пользователю возвращается Bearer токен.

### 3 Обновление пользователя
PUT запрос по /api/v1/users/0 с сущностью пользователя.
Обновление пароля и email не производится.

## Сущности

### Сессия
Поле | Тип | Обязательное | Описание
--- | --- | --- | ---
session_id | string | Да | Идентификтаор сессии (токен)
user_id | integer | Да | Идентификатор пользователя
created_at | datetime | Да | Дата создания токена
valid_until | datetime | Да | Дата, до которой сессия считается действительной

### Пользователь
Поле | Тип | Обязательное | Описание
--- | --- | --- | ---
id | integer | Да | Идентификатор
first_name | string | Да | Имя
last_name | string | Да | Фамилия
birthday | datetime | Нет | День рождения
email | string | Да | Email, уникальный
password | string | Да | Пароль
created_at | datetime | Да | Дата регистрации
updated_at | datetime | Да | Дата последнего обновления пользователя

Email уникален, но пользователь может его изменить.
Пароль хранится в виде хэша.

### Лот
Поле | Тип | Обязательное | Описание
--- | --- | --- | ---
id | integer | Да | Идентификатор
creator_id | integer | Да | Идентификатор пользователя, создавшего лот
title | string | Да | Заголовок
description | string | Нет | Описание
min_price | float64 | Да | Минимальная цена
price_step | float64 | Да | Шаг изменения цены
created_at | datetime | Да | Дата создания
updated_at | datetime | Да | Дата последнего обновления

1. Получение всех торгуемых лотов

GET /lots?status=active

  При помощи параметра status реализована возможность отфильтровать получаемую выборку лотов


2. Получение деталей лота по идентификатору

  GET /lots/{id}


3. Обновление цены лота пользователем

  PUT /lots/{id}/buy

  При выполнении операции покупки должны быть проверены следующие условия

  * Лот не может быть куплен создателем лота или текущим покупателем

  * Лот должен быть в статусе active

  * Цена лота должна быть кратна price_step

  * Новая передаваемая цена должна быть больше текущей buy_price


4. Создан бэкграунд процесс, который запускается раз в секунду и переводит все лоты с просроченным `end_at` в статус `finished`


5. Реализован двунаправленный обмен клиента с сервером для получение по вебсокету обновлений деталей по лотам

При изменении, объект-лот отправляется всем клиентам в формате json

6. Реализована выдача выше перечисленных ресурсов в html-представлении (с помощью html/template) и обновление с помощью websocket на странице всех лотов + на странице деталей лота

###Микросервисы



1) gateway-api - отвечает за аутентификацию, авторизацию, получении/редактирование/создании пользователя

При запросе ресурса (вызова “ручки” rest-сервиса) gateway-api находит пользователя по переданному токену и проверяет разрешенность операции пользователем.

В случае если пользователь не найден по токену или операция не разрешена переданному пользователю должна возвращаться ошибка клиенту о невозможности выполнения операции.


2) auction-api - отвечает за операции с лотами(получение/создание/редактирование/покупку/закрытие лотов)

Аукцион принимает запросы только по идентификатору клиента. Токен не передается в auction-api.


Взаимодействие клиента с gateway-api  осуществляется по REST + HTML + WebSocket.

Взаимодействие gateway-api с auction-api  происходит по gRPC протоколу.

Web клиент и мобильное приложение взаимодействует только с gateway-api и не может напрямую вызывать auction-api.